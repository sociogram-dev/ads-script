!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";class e{data=null;collect(){try{return"undefined"==typeof window||"undefined"==typeof navigator?null:(this.data={timestamp:(new Date).toISOString(),page:{url:window.location.href,title:document.title,referrer:document.referrer||"direct",domain:window.location.hostname,path:window.location.pathname},browser:{language:navigator.language,languages:navigator.languages,platform:navigator.platform,cookieEnabled:navigator.cookieEnabled,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone},device:{screenWidth:screen.width,screenHeight:screen.height,pixelRatio:window.devicePixelRatio,viewportWidth:window.innerWidth,viewportHeight:window.innerHeight},connection:navigator.connection?{effectiveType:navigator.connection.effectiveType,saveData:navigator.connection.saveData}:null,hardware:{hardwareConcurrency:navigator.hardwareConcurrency,maxTouchPoints:navigator.maxTouchPoints}},this.data)}catch(e){return console.error("Error collecting fingerprint data:",e),null}}getData(){return this.data}}const t="sociogram:client:id",n=e=>{const t=e.toLowerCase();return t.includes("rabby")?"rabby":t.includes("trust")?"trustwallet":t.includes("coinbase")?"base":t},o=()=>window.crypto&&window.crypto.randomUUID?window.crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),a=[{name:"metamask",rdns:"io.metamask",check:()=>window.ethereum?.isMetaMask?window.ethereum:void 0},{name:"phantom",rdns:"app.phantom",check:()=>window.phantom?.ethereum},{name:"coinbase wallet",rdns:"com.coinbase.wallet",check:()=>window.ethereum?.isCoinbaseWallet?window.ethereum:void 0},{name:"trust wallet",rdns:"com.trustwallet.app",check:()=>window.ethereum?.isTrust?window.ethereum:void 0},{name:"rabby",rdns:"io.rabby",check:()=>window.ethereum?.isRabby?window.ethereum:void 0},{name:"okx wallet",rdns:"com.okex.wallet",check:()=>window.okxwallet},{name:"bitget wallet",rdns:"com.bitget.web3",check:()=>{const e=window;return e.bitget?.ethereum||e.bitkeep?.ethereum||(e.ethereum?.isBitget?e.ethereum:void 0)}},{name:"binance wallet",rdns:"com.binance.chainwallet",check:()=>window.BinanceChain}];class s{walletData=[];addressFound=!1;eventListenersAttached=!1;onAddressDetected;discoveredProviders=[];constructor(e){this.onAddressDetected=e}async init(){console.log("ðŸ” Wallet Detector started"),"undefined"!=typeof window&&(this.discoveredProviders=await this.discoverProviders(),console.log("ðŸ” Discovered providers:",this.discoveredProviders.map(e=>e.info.name)),await this.runInitialDetection(),this.addressFound?console.log("âœ… Address found immediately"):(console.log("â³ No wallet detected, listening for connection events..."),this.attachEventListeners(this.discoveredProviders)))}async runInitialDetection(){this.detectWalletConnect(),this.addressFound||(this.scanDOM(),this.addressFound||await this.detectConnectedWallets())}async detectConnectedWallets(){if(this.addressFound)return this.walletData;this.walletData=[];for(const t of this.discoveredProviders){if(this.addressFound)break;try{const e=await this.getWalletInfo(t);e&&(this.walletData.push(e),e.addresses.length>0&&await this.reportAddress(e.addresses[0],`${e.name} provider`))}catch(e){console.warn(`Failed to get info for ${t.info.name}:`,e instanceof Error?e.message:String(e))}}return this.walletData}async discoverProviders(){const e=new Map;await new Promise(t=>{const n=t=>{e.has(t.detail.info.rdns)||e.set(t.detail.info.rdns,t.detail)};window.addEventListener("eip6963:announceProvider",n),window.dispatchEvent(new Event("eip6963:requestProvider")),setTimeout(()=>{window.removeEventListener("eip6963:announceProvider",n),t()},500)});for(const t of a)if(!e.has(t.rdns)){const n=t.check();n&&e.set(t.rdns,{info:{name:t.name,rdns:t.rdns,uuid:o()},provider:n})}return Array.from(e.values())}async getWalletInfo(e){const{provider:t,info:o}=e;if("request"in t&&"function"==typeof t.request)try{const e=await Promise.race([t.request({method:"eth_accounts"}),new Promise((e,t)=>setTimeout(()=>t(new Error("Request timed out after 1s")),1e3))]);if(!e||0===e.length)return null;const a=await t.request({method:"eth_chainId"});return{name:n(o.name),addresses:e,chainId:a,hasProvider:!0}}catch{return null}return null}attachEventListeners(e){this.eventListenersAttached||(this.eventListenersAttached=!0,e.forEach(({provider:e,info:t})=>{if("on"in e&&"function"==typeof e.on){const n=e=>{e&&e.length>0&&this.reportAddress(e[0],`${t.name} (accountsChanged)`)};e.on("accountsChanged",n)}}),console.log(`ðŸ‘‚ Attached listeners to ${e.length} providers.`))}async reportAddress(e,t){this.addressFound||e&&this.isValidAddress(e)&&(this.addressFound=!0,console.log(`âœ… Address detected from ${t}:`,e.toLowerCase()),this.onAddressDetected&&this.onAddressDetected(e.toLowerCase(),t))}isValidAddress(e){return/^0x[a-fA-F0-9]{40}$/.test(e)}detectWalletConnect(){if(!this.addressFound)try{const e=Object.keys(localStorage).filter(e=>e.startsWith("wc@2")||e.includes("walletconnect"));for(const t of e){if(this.addressFound)break;try{const e=JSON.parse(localStorage.getItem(t)||"");this.extractAddressFromObject(e,"WalletConnect")}catch{}}}catch{}}scanDOM(){if(!this.addressFound)try{const e=document.body.innerText.match(/0x[a-fA-F0-9]{40}/g);if(e?.[0])return void this.reportAddress(e[0],"DOM scan");const t=document.querySelectorAll("[data-address], [data-account], [data-wallet]");for(const n of t){if(this.addressFound)break;const e=n.dataset.address||n.dataset.account||n.dataset.wallet;e&&this.reportAddress(e,"DOM data-attribute")}}catch(e){console.error("DOM scan failed:",e)}}extractAddressFromObject(e,t){if(!this.addressFound)try{const n=("string"==typeof e?e:JSON.stringify(e)).match(/0x[a-fA-F0-9]{40}/);n&&this.reportAddress(n[0],t)}catch{}}getWalletData(){return this.walletData}}class r{baseUrl="https://stage.sociogram.cloud/api";async sendAuctionRequest(e){const t=`${this.baseUrl}/ad/auction`;try{console.log("ðŸš€ Sending auction request to:",t),console.log("ðŸ“¦ Payload:",e);const n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=await n.json();return console.log("âœ… Auction request successful:",o),o}catch(n){throw console.error("âŒ Auction request failed:",n),n}}}class i{constructor(){console.log("ðŸ” Injector initialized")}buildIframe(e){const t=document.createElement("iframe");return t.src=e,t.style.border="none",t.style.display="block",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="transparent",t.setAttribute("scrolling","no"),t.setAttribute("frameborder","0"),t.setAttribute("allow","clipboard-write; encrypted-media"),t.setAttribute("role","presentation"),t.setAttribute("sandbox","allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-forms"),t}buildFrameUrl(e,t,n){const o=new URLSearchParams({id:e,size:t||""});return n&&(o.append("campId",n.campId),o.append("unitId",n.unitId),n.clientId&&o.append("clientId",n.clientId),n.address&&o.append("address",n.address)),`https://stage.sociogram.cloud/?${o.toString()}`}inject({slot:e,blockId:t,metricData:n}){try{const o=this.buildFrameUrl(t,e.dataset.adSize,n),a=this.buildIframe(o);e.appendChild(a)}catch(o){console.error("Failed to inject ad:",o),e.style.display="none"}}}class d{queue;walletDetector;fingerprintCollector;apiClient;injector;lastUrl=location.href;clientId;constructor(){this.clientId=(()=>{const e=localStorage.getItem(t),n=o(),a=e||n;return a!==e&&localStorage.setItem(t,a),a})(),this.queue=window.sociogramPromo=window.sociogramPromo||[],this.walletDetector=new s((e,t)=>{console.log(`ðŸ’° Wallet detected: ${e} from ${t}`)}),this.fingerprintCollector=new e,this.apiClient=new r,this.injector=new i,this.processExistingQueue().catch(console.error),this.replacePushMethod(),this.initializeSPAHandling()}async processExistingQueue(){for(const e of this.queue)await this.processCommand(e)}replacePushMethod(){this.queue.push=e=>(this.processCommand(e).catch(console.error),Array.prototype.push.call(this.queue,e))}async processCommand(e){"{}"===JSON.stringify(e)?await this.findAndRenderAds():console.warn("Sociogram Ads: Received an unknown command.",e)}async findAndRenderAds(){await this.detectWallet();const e=document.querySelectorAll("ins.sociogramPromo");for(const t of e)"filled"!==t.dataset.adStatus&&await this.renderAd(t)}async detectWallet(){try{await this.walletDetector.init();const e=this.walletDetector.getWalletData();console.log("ðŸ“Š Wallet data collected:",e)}catch(e){console.warn("Wallet detection failed:",e)}}async renderAd(e){e.dataset.adStatus="filled";const t=(n=this.fingerprintCollector,o=this.walletDetector,{fingerprint:n.collect(),walletInfo:o.getWalletData()});var n,o;const a=await this.sendAuctionRequest(t.fingerprint,t.walletInfo,e.dataset.adClient||"");if(a&&a.blockId&&a.campId){const t=this.walletDetector.getWalletData(),n={campId:a.campId,unitId:e.dataset.adClient||"",address:t.length>0&&t[0].addresses.length>0?t[0].addresses[0]:"",clientId:this.clientId};this.injector.inject({slot:e,blockId:a.blockId,metricData:n})}else console.warn("No valid ad response, hiding slot:",e),e.style.display="none"}async sendAuctionRequest(e,t,n){try{const o=((e,t,n,o)=>({page:{url:e.page.url,title:e.page.title,referrer:e.page.referrer,domain:e.page.domain,path:e.page.path},browser:{language:e.browser.language,languages:Array.from(e.browser.languages),platform:e.browser.platform,timezone:e.browser.timezone},device:{screenWidth:e.device.screenWidth,screenHeight:e.device.screenHeight,pixelRatio:e.device.pixelRatio,viewportWidth:e.device.viewportWidth,viewportHeight:e.device.viewportHeight},wallets:t.map(e=>({address:e.addresses.length>0?e.addresses[0]:"",name:e.name,chainId:e.chainId})),unitId:n,clientId:o}))(e,t,n,this.clientId);return await this.apiClient.sendAuctionRequest(o)}catch(o){return console.error(o),null}}initializeSPAHandling(){new MutationObserver(()=>{location.href!==this.lastUrl&&(this.lastUrl=location.href,setTimeout(()=>{this.findAndRenderAds().catch(console.error)},500))}).observe(document.body,{childList:!0,subtree:!0})}}!function(){const e=()=>new d;"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}()});
