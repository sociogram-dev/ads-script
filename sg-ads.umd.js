!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";class e{data=null;collect(){try{return"undefined"==typeof window||"undefined"==typeof navigator?null:(this.data={timestamp:(new Date).toISOString(),page:{url:window.location.href,title:document.title,referrer:document.referrer||"direct",domain:window.location.hostname,path:window.location.pathname},browser:{language:navigator.language,languages:navigator.languages,platform:navigator.platform,cookieEnabled:navigator.cookieEnabled,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone},device:{screenWidth:screen.width,screenHeight:screen.height,pixelRatio:window.devicePixelRatio,viewportWidth:window.innerWidth,viewportHeight:window.innerHeight},connection:navigator.connection?{effectiveType:navigator.connection.effectiveType,saveData:navigator.connection.saveData}:null,hardware:{hardwareConcurrency:navigator.hardwareConcurrency,maxTouchPoints:navigator.maxTouchPoints}},this.data)}catch(e){return null}}getData(){return this.data}}const t="sociogram:client:id",n=e=>{const t=e.toLowerCase();return t.includes("rabby")?"rabby":t.includes("trust")?"trustwallet":t.includes("coinbase")?"base":t},s=()=>window.crypto&&window.crypto.randomUUID?window.crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),i=[{name:"metamask",rdns:"io.metamask",check:()=>window.ethereum?.isMetaMask?window.ethereum:void 0},{name:"phantom",rdns:"app.phantom",check:()=>window.phantom?.ethereum},{name:"coinbase wallet",rdns:"com.coinbase.wallet",check:()=>window.ethereum?.isCoinbaseWallet?window.ethereum:void 0},{name:"trust wallet",rdns:"com.trustwallet.app",check:()=>window.ethereum?.isTrust?window.ethereum:void 0},{name:"rabby",rdns:"io.rabby",check:()=>window.ethereum?.isRabby?window.ethereum:void 0},{name:"okx wallet",rdns:"com.okex.wallet",check:()=>window.okxwallet},{name:"bitget wallet",rdns:"com.bitget.web3",check:()=>{const e=window;return e.bitget?.ethereum||e.bitkeep?.ethereum||(e.ethereum?.isBitget?e.ethereum:void 0)}},{name:"binance wallet",rdns:"com.binance.chainwallet",check:()=>window.BinanceChain}];class a{walletData=[];addressFound=!1;eventListenersAttached=!1;onAddressDetected;discoveredProviders=[];constructor(e){this.onAddressDetected=e}async init(){"undefined"!=typeof window&&(this.discoveredProviders=await this.discoverProviders(),await this.runInitialDetection(),this.addressFound||this.attachEventListeners(this.discoveredProviders))}async runInitialDetection(){this.detectWalletConnect(),this.addressFound||(this.scanDOM(),this.addressFound||await this.detectConnectedWallets())}async detectConnectedWallets(){if(this.addressFound)return this.walletData;this.walletData=[];for(const t of this.discoveredProviders){if(this.addressFound)break;try{const e=await this.getWalletInfo(t);e&&(this.walletData.push(e),e.addresses.length>0&&await this.reportAddress(e.addresses[0],`${e.name} provider`))}catch(e){}}return this.walletData}async discoverProviders(){const e=new Map;await new Promise(t=>{const n=t=>{e.has(t.detail.info.rdns)||e.set(t.detail.info.rdns,t.detail)};window.addEventListener("eip6963:announceProvider",n),window.dispatchEvent(new Event("eip6963:requestProvider")),setTimeout(()=>{window.removeEventListener("eip6963:announceProvider",n),t()},500)});for(const t of i)if(!e.has(t.rdns)){const n=t.check();n&&e.set(t.rdns,{info:{name:t.name,rdns:t.rdns,uuid:s()},provider:n})}return Array.from(e.values())}async getWalletInfo(e){const{provider:t,info:s}=e;if("request"in t&&"function"==typeof t.request)try{const e=await Promise.race([t.request({method:"eth_accounts"}),new Promise((e,t)=>setTimeout(()=>t(new Error("Request timed out after 1s")),1e3))]);if(!e||0===e.length)return null;const i=await t.request({method:"eth_chainId"});return{name:n(s.name),addresses:e,chainId:i,hasProvider:!0}}catch{return null}return null}attachEventListeners(e){this.eventListenersAttached||(this.eventListenersAttached=!0,e.forEach(({provider:e,info:t})=>{if("on"in e&&"function"==typeof e.on){const n=e=>{e&&e.length>0&&this.reportAddress(e[0],`${t.name} (accountsChanged)`)};e.on("accountsChanged",n)}}))}async reportAddress(e,t){this.addressFound||e&&this.isValidAddress(e)&&(this.addressFound=!0,this.onAddressDetected&&this.onAddressDetected(e.toLowerCase(),t))}isValidAddress(e){return/^0x[a-fA-F0-9]{40}$/.test(e)}detectWalletConnect(){if(!this.addressFound)try{const e=Object.keys(localStorage).filter(e=>e.startsWith("wc@2")||e.includes("walletconnect"));for(const t of e){if(this.addressFound)break;try{const e=JSON.parse(localStorage.getItem(t)||"");this.extractAddressFromObject(e,"WalletConnect")}catch{}}}catch{}}scanDOM(){if(!this.addressFound)try{const e=document.body.innerText.match(/0x[a-fA-F0-9]{40}/g);if(e?.[0])return void this.reportAddress(e[0],"DOM scan");const t=document.querySelectorAll("[data-address], [data-account], [data-wallet]");for(const n of t){if(this.addressFound)break;const e=n.dataset.address||n.dataset.account||n.dataset.wallet;e&&this.reportAddress(e,"DOM data-attribute")}}catch(e){}}extractAddressFromObject(e,t){if(!this.addressFound)try{const n=("string"==typeof e?e:JSON.stringify(e)).match(/0x[a-fA-F0-9]{40}/);n&&this.reportAddress(n[0],t)}catch{}}getWalletData(){return this.walletData}}class r{baseUrl="https://sociogram.cloud//api";async sendAuctionRequest(e){const t=`${this.baseUrl}/ad/auction`;try{const n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}catch(n){throw n}}}class o{constructor(){}buildIframe(e){const t=document.createElement("iframe");return t.src=e,t.style.border="none",t.style.display="block",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="transparent",t.setAttribute("scrolling","no"),t.setAttribute("frameborder","0"),t.setAttribute("allow","clipboard-write; encrypted-media"),t.setAttribute("role","presentation"),t.setAttribute("sandbox","allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-forms"),t}inject(e,t){try{const n=`https://sociogram.cloud//?id=${t}&size=${e.dataset.adSize}`,s=this.buildIframe(n);e.appendChild(s)}catch(n){e.style.display="none"}}}class d{queue;walletDetector;fingerprintCollector;apiClient;injector;intersectionObserver=null;lastUrl=location.href;clientId;campaignIds=new Map;constructor(){this.clientId=(()=>{const e=localStorage.getItem(t),n=s(),i=e||n;return i!==e&&localStorage.setItem(t,i),i})(),this.queue=window.sociogramAds=window.sociogramAds||[],this.walletDetector=new a((e,t)=>{}),this.fingerprintCollector=new e,this.apiClient=new r,this.injector=new o,this.processExistingQueue().catch(console.error),this.replacePushMethod(),window.addEventListener("beforeunload",()=>{this.cleanup()}),this.initializeSPAHandling()}async processExistingQueue(){for(const e of this.queue)await this.processCommand(e)}replacePushMethod(){this.queue.push=e=>(this.processCommand(e).catch(console.error),Array.prototype.push.call(this.queue,e))}async processCommand(e){"{}"===JSON.stringify(e)&&await this.findAndRenderAds()}async findAndRenderAds(){await this.detectWallet(),this.initializeIntersectionObserver();const e=document.querySelectorAll("ins.sociogramAds");for(const t of e)"filled"!==t.dataset.adStatus&&(await this.renderAd(t),this.intersectionObserver?.observe(t))}initializeIntersectionObserver(){this.intersectionObserver||(this.intersectionObserver=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target;this.trackAdVisibility(t),this.intersectionObserver?.unobserve(t)}})},{root:null,rootMargin:"0px",threshold:.8}))}trackAdVisibility(e){const t=this.campaignIds.get(e);if(t)try{const n=this.walletDetector.getWalletData(),s=n.length>0&&n[0].addresses.length>0?n[0].addresses[0]:void 0,i=e.dataset.adClient||"",a=e.querySelector("iframe");if(a&&a.contentWindow){const e={campId:t,unitId:i,address:s,clientId:this.clientId};a.contentWindow.postMessage({type:"adInView",data:e},"*")}}catch(n){}}async detectWallet(){try{await this.walletDetector.init();this.walletDetector.getWalletData()}catch(e){}}async renderAd(e){e.dataset.adStatus="filled";const t=(n=this.fingerprintCollector,s=this.walletDetector,{fingerprint:n.collect(),walletInfo:s.getWalletData()});var n,s;const i=await this.sendAuctionRequest(t.fingerprint,t.walletInfo,e.dataset.adClient||"");i&&i.blockId&&i.campId?(this.campaignIds.set(e,i.campId),this.injector.inject(e,i.blockId)):e.style.display="none"}async sendAuctionRequest(e,t,n){try{const s=((e,t,n,s)=>({page:{url:e.page.url,title:e.page.title,referrer:e.page.referrer,domain:e.page.domain,path:e.page.path},browser:{language:e.browser.language,languages:Array.from(e.browser.languages),platform:e.browser.platform,timezone:e.browser.timezone},device:{screenWidth:e.device.screenWidth,screenHeight:e.device.screenHeight,pixelRatio:e.device.pixelRatio,viewportWidth:e.device.viewportWidth,viewportHeight:e.device.viewportHeight},wallets:t.map(e=>({address:e.addresses.length>0?e.addresses[0]:"",name:e.name,chainId:e.chainId})),unitId:n,clientId:s}))(e,t,n,this.clientId);return await this.apiClient.sendAuctionRequest(s)}catch(s){return null}}initializeSPAHandling(){new MutationObserver(()=>{location.href!==this.lastUrl&&(this.lastUrl=location.href,setTimeout(()=>{this.findAndRenderAds().catch(console.error)},500))}).observe(document.body,{childList:!0,subtree:!0})}cleanup(){this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null)}}!function(){const e=()=>new d;"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}()});
